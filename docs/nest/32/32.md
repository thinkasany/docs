[SQL 查询语句的所有语法和函数](https://juejin.cn/book/7226988578700525605/section/7238472325102829629)

## 建表

### 我们先建个表：

```sql
CREATE TABLE student(
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'Id',
    name VARCHAR(50) NOT NULL COMMENT '学生名',
    gender VARCHAR(10) NOT NULL COMMENT '性别',
    age INT NOT NULL COMMENT '年龄',
    class VARCHAR(50) NOT NULL COMMENT '班级名',
    score INT NOT NULL COMMENT '分数'
) CHARSET=utf8mb4
```

这是学生表。

id 为主键，设置自动增长。

name 为名字，非空。

gender 为性别，非空。

age 为年龄，非空。

class 为班级名，非空。

score 为成绩，非空。

### 删表

```
drop table student;
```

### 查表

```
SELECT * FROM student;
```

### 插入数据

```
INSERT INTO student (name, gender, age, class, score)
    VALUES
        ('张三', '男',18, '一班',90),
        ('李四', '女',19, '二班',85),
        ('王五', '男',20, '三班',70),
        ('赵六', '女',18, '一班',95),
        ('钱七', '男',19, '二班',80),
        ('孙八', '女',20, '三班',75),
        ('周九', '男',18, '一班',85),
        ('吴十', '女',19, '二班',90),
        ('郑十一', '男',20, '三班',60),
        ('王十二', '女',18, '一班',95),
        ('赵十三', '男',19, '二班',75),
        ('钱十四', '女',20, '三班',80),
        ('孙十五', '男',18, '一班',90),
        ('周十六', '女',19, '二班',85),
        ('吴十七', '男',20, '三班',70),
        ('郑十八', '女',18, '一班',95),
        ('王十九', '男',19, '二班',80),
        ('赵二十', '女',20, '三班',75);
```

## sql练习

### 首先，查询是可以指定查询的列的：

```
SELECT name, score FROM student;
```

```
+-----------+-------+
| name      | score |
+-----------+-------+
| 张三      |    90 |
| 李四      |    85 |
| 王五      |    70 |
| 赵六      |    95 |
| 钱七      |    80 |
| 孙八      |    75 |
| 周九      |    85 |
| 吴十      |    90 |
| 郑十一    |    60 |
| 王十二    |    95 |
| 赵十三    |    75 |
| 钱十四    |    80 |
| 孙十五    |    90 |
| 周十六    |    85 |
| 吴十七    |    70 |
| 郑十八    |    95 |
| 王十九    |    80 |
| 赵二十    |    75 |
+-----------+-------+
```

select \* 是查询所有列的意思。

可以通过 as 修改返回的列名：

```
SELECT name as "名字", score as "分数" FROM student;
```

```
+-----------+--------+
| 名字      | 分数   |
+-----------+--------+
| 张三      |     90 |
| 李四      |     85 |
| 王五      |     70 |
| 赵六      |     95 |
| 钱七      |     80 |
| 孙八      |     75 |
| 周九      |     85 |
| 吴十      |     90 |
| 郑十一    |     60 |
| 王十二    |     95 |
| 赵十三    |     75 |
| 钱十四    |     80 |
| 孙十五    |     90 |
| 周十六    |     85 |
| 吴十七    |     70 |
| 郑十八    |     95 |
| 王十九    |     80 |
| 赵二十    |     75 |
+-----------+--------+
```

## where and 查询

查询自然是可以带条件的，通过 where, 并且条件可以是 and 连接的多个：

```
select name as '名字',class as '班级' from student where gender='男' and score >= 90;
```

```
+-----------+--------+
| 名字      | 班级   |
+-----------+--------+
| 张三      | 一班   |
| 孙十五    | 一班   |
+-----------+--------+
```

## LIKE 做模糊查询

可以看到，有两个成绩在 90 以上的男生。
比如查询名字以“王”开头的学生：

```
select * from student where name like '王%';
```

```
+----+-----------+--------+-----+--------+-------+
| id | name      | gender | age | class  | score |
+----+-----------+--------+-----+--------+-------+
|  3 | 王五      | 男     |  20 | 三班   |    70 |
| 10 | 王十二    | 女     |  18 | 一班   |    95 |
| 17 | 王十九    | 男     |  19 | 二班   |    80 |
+----+-----------+--------+-----+--------+-------+
```

## in 来指定一个集合

```
select * from student where class in ('一班', '二班');
```

```
+----+-----------+--------+-----+--------+-------+
| id | name      | gender | age | class  | score |
+----+-----------+--------+-----+--------+-------+
|  1 | 张三      | 男     |  18 | 一班   |    90 |
|  2 | 李四      | 女     |  19 | 二班   |    85 |
|  4 | 赵六      | 女     |  18 | 一班   |    95 |
|  5 | 钱七      | 男     |  19 | 二班   |    80 |
|  7 | 周九      | 男     |  18 | 一班   |    85 |
|  8 | 吴十      | 女     |  19 | 二班   |    90 |
| 10 | 王十二    | 女     |  18 | 一班   |    95 |
| 11 | 赵十三    | 男     |  19 | 二班   |    75 |
| 13 | 孙十五    | 男     |  18 | 一班   |    90 |
| 14 | 周十六    | 女     |  19 | 二班   |    85 |
| 16 | 郑十八    | 女     |  18 | 一班   |    95 |
| 17 | 王十九    | 男     |  19 | 二班   |    80 |
+----+-----------+--------+-----+--------+-------+
```

## not in

```
select * from student where class not in ('一班', '二班');
```

```
+----+-----------+--------+-----+--------+-------+
| id | name      | gender | age | class  | score |
+----+-----------+--------+-----+--------+-------+
|  3 | 王五      | 男     |  20 | 三班   |    70 |
|  6 | 孙八      | 女     |  20 | 三班   |    75 |
|  9 | 郑十一    | 男     |  20 | 三班   |    60 |
| 12 | 钱十四    | 女     |  20 | 三班   |    80 |
| 15 | 吴十七    | 男     |  20 | 三班   |    70 |
| 18 | 赵二十    | 女     |  20 | 三班   |    75 |
+----+-----------+--------+-----+--------+-------+
```

## in 集合，通过between and 指定区间

```
select * from student where age between 18 and 19;
```

```
+----+-----------+--------+-----+--------+-------+
| id | name      | gender | age | class  | score |
+----+-----------+--------+-----+--------+-------+
|  1 | 张三      | 男     |  18 | 一班   |    90 |
|  2 | 李四      | 女     |  19 | 二班   |    85 |
|  4 | 赵六      | 女     |  18 | 一班   |    95 |
|  5 | 钱七      | 男     |  19 | 二班   |    80 |
|  7 | 周九      | 男     |  18 | 一班   |    85 |
|  8 | 吴十      | 女     |  19 | 二班   |    90 |
| 10 | 王十二    | 女     |  18 | 一班   |    95 |
| 11 | 赵十三    | 男     |  19 | 二班   |    75 |
| 13 | 孙十五    | 男     |  18 | 一班   |    90 |
| 14 | 周十六    | 女     |  19 | 二班   |    85 |
| 16 | 郑十八    | 女     |  18 | 一班   |    95 |
| 17 | 王十九    | 男     |  19 | 二班   |    80 |
+----+-----------+--------+-----+--------+-------+
```

## limit分页返回

```
select * from student limit 0,3;
```

这种也可以简化为：

```
select * from student limit 3;
```

```
+----+--------+--------+-----+--------+-------+
| id | name   | gender | age | class  | score |
+----+--------+--------+-----+--------+-------+
|  1 | 张三   | 男     |  18 | 一班   |    90 |
|  2 | 李四   | 女     |  19 | 二班   |    85 |
|  3 | 王五   | 男     |  20 | 三班   |    70 |
+----+--------+--------+-----+--------+-------+
```

## order by 指定排序的列

```
select name,score,age from student order by score asc,age desc;
```

order by 指定根据 score 升序排列，如果 score 相同再根据 age 降序排列。

```
+-----------+-------+-----+
| name      | score | age |
+-----------+-------+-----+
| 郑十一    |    60 |  20 |
| 王五      |    70 |  20 |
| 吴十七    |    70 |  20 |
| 孙八      |    75 |  20 |
| 赵二十    |    75 |  20 |
| 赵十三    |    75 |  19 |
| 钱十四    |    80 |  20 |
| 钱七      |    80 |  19 |
| 王十九    |    80 |  19 |
| 李四      |    85 |  19 |
| 周十六    |    85 |  19 |
| 周九      |    85 |  18 |
| 吴十      |    90 |  19 |
| 张三      |    90 |  18 |
| 孙十五    |    90 |  18 |
| 赵六      |    95 |  18 |
| 王十二    |    95 |  18 |
| 郑十八    |    95 |  18 |
+-----------+-------+-----+
```

## HAVING

WHERE 子句用于在分组之前筛选行，它作用于单个行级数据，即在数据进行分组之前，用于过滤原始数据集中的行。它通常用于筛选数据，而不是用于聚合后的结果。

HAVING 子句用于在分组后筛选数据，它作用于分组后的结果集，用于过滤聚合数据。HAVING 子句允许你在分组后对聚合结果进行筛选，并且可以使用聚合函数（如 SUM、COUNT、AVG 等）进行条件筛选。

```
SELECT class,AVG(score) AS avg_score FROM student GROUP BY class HAVING avg_score > 90;
```

```
+--------+-----------+
| class  | avg_score |
+--------+-----------+
| 一班   |   91.6667 |
+--------+-----------+
```

## distinct 去重

```
SELECT DISTINCT class FROM student;
```

```
+--------+
| class  |
+--------+
| 一班   |
| 二班   |
| 三班   |
+--------+
```

## 聚合函数

用于对数据的统计，比如 AVG、COUNT、SUM、MIN、MAX。

```
select avg(score) as '平均成绩',count(*) as '人数',sum(score) as '总成绩',min(score) as '最低分', max(score) as '最高分' from student;
```

```
+--------------+--------+-----------+-----------+-----------+
| 平均成绩     | 人数   | 总成绩    | 最低分    | 最高分    |
+--------------+--------+-----------+-----------+-----------+
|      81.9444 |     18 |      1475 |        60 |        95 |
+--------------+--------+-----------+-----------+-----------+
```

## 字符串函数

用于对字符串的处理，比如 CONCAT、SUBSTR、LENGTH、UPPER、LOWER。

```
SELECT CONCAT('xx', name, 'yy'), SUBSTR(name,2,3), LENGTH(name), UPPER('aa'), LOWER('TT') FROM student;
```

```
+--------------------------+------------------+--------------+-------------+-------------+
| CONCAT('xx', name, 'yy') | SUBSTR(name,2,3) | LENGTH(name) | UPPER('aa') | LOWER('TT') |
+--------------------------+------------------+--------------+-------------+-------------+
| xx张三yy                 | 三               |            6 | AA          | tt          |
| xx李四yy                 | 四               |            6 | AA          | tt          |
| xx王五yy                 | 五               |            6 | AA          | tt          |
| xx赵六yy                 | 六               |            6 | AA          | tt          |
| xx钱七yy                 | 七               |            6 | AA          | tt          |
| xx孙八yy                 | 八               |            6 | AA          | tt          |
| xx周九yy                 | 九               |            6 | AA          | tt          |
| xx吴十yy                 | 十               |            6 | AA          | tt          |
| xx郑十一yy               | 十一             |            9 | AA          | tt          |
| xx王十二yy               | 十二             |            9 | AA          | tt          |
| xx赵十三yy               | 十三             |            9 | AA          | tt          |
| xx钱十四yy               | 十四             |            9 | AA          | tt          |
| xx孙十五yy               | 十五             |            9 | AA          | tt          |
| xx周十六yy               | 十六             |            9 | AA          | tt          |
| xx吴十七yy               | 十七             |            9 | AA          | tt          |
| xx郑十八yy               | 十八             |            9 | AA          | tt          |
| xx王十九yy               | 十九             |            9 | AA          | tt          |
| xx赵二十yy               | 二十             |            9 | AA          | tt          |
+--------------------------+------------------+--------------+-------------+-------------+
```

## 数值函数

用于对数值的处理，比如 ROUND、CEIL、FLOOR、ABS、MOD。

```
SELECT ROUND(1.234567, 2), CEIL(1.234567), FLOOR(1.234567), ABS(-1.234567), MOD(5, 2);
```

分别是 ROUND 四舍五入、CEIL 向上取整、FLOOR 向下取整、ABS 绝对值、MOD 取模。

```
+--------------------+----------------+-----------------+----------------+-----------+
| ROUND(1.234567, 2) | CEIL(1.234567) | FLOOR(1.234567) | ABS(-1.234567) | MOD(5, 2) |
+--------------------+----------------+-----------------+----------------+-----------+
|               1.23 |              2 |               1 |       1.234567 |         1 |
+--------------------+----------------+-----------------+----------------+-----------+
```

## 日期函数

对日期、时间进行处理，比如 DATE、TIME、YEAR、MONTH、DAY

```
SELECT YEAR('2023-06-01 22:06:03'), MONTH('2023-06-01 22:06:03'),DAY('2023-06-01 22:06:03'),DATE('2023-06-01 22:06:03'), TIME('2023-06-01 22:06:03');
```

```
+-----------------------------+------------------------------+----------------------------+-----------------------------+-----------------------------+
| YEAR('2023-06-01 22:06:03') | MONTH('2023-06-01 22:06:03') | DAY('2023-06-01 22:06:03') | DATE('2023-06-01 22:06:03') | TIME('2023-06-01 22:06:03') |
+-----------------------------+------------------------------+----------------------------+-----------------------------+-----------------------------+
|                        2023 |                            6 |                          1 | 2023-06-01                  | 22:06:03                    |
+-----------------------------+------------------------------+----------------------------+-----------------------------+-----------------------------+
```

## 条件函数

根据条件是否成立返回不同的值，比如 IF、CASE

```
select name, if(score >=60, '及格', '不及格') from student;
```

```
SELECT name, score, CASE WHEN score >=90 THEN '优秀' WHEN score >=60 THEN '良好'ELSE '差' END AS '档次' FROM student;
```

if 和 case 函数和 js 里的 if、swtch 语句很像，很容易理解。

if 函数适合单个条件，case 适合多个条件。

```
+-----------+-------+--------+
| name      | score | 档次   |
+-----------+-------+--------+
| 张三      |    90 | 优秀   |
| 李四      |    85 | 良好   |
| 王五      |    70 | 良好   |
| 赵六      |    95 | 优秀   |
| 钱七      |    80 | 良好   |
| 孙八      |    75 | 良好   |
| 周九      |    85 | 良好   |
| 吴十      |    90 | 优秀   |
| 郑十一    |    60 | 良好   |
| 王十二    |    95 | 优秀   |
| 赵十三    |    75 | 良好   |
| 钱十四    |    80 | 良好   |
| 孙十五    |    90 | 优秀   |
| 周十六    |    85 | 良好   |
| 吴十七    |    70 | 良好   |
| 郑十八    |    95 | 优秀   |
| 王十九    |    80 | 良好   |
| 赵二十    |    75 | 良好   |
+-----------+-------+--------+
```

## 系统函数

用于获取系统信息，比如 VERSION、DATABASE、USER。

```
select VERSION(), DATABASE(), USER();
```

```
+-----------+------------+----------------+
| VERSION() | DATABASE() | USER()         |
+-----------+------------+----------------+
| 8.0.30    | practice   | root@localhost |
+-----------+------------+----------------+
```

## 其他函数

NULLIF、COALESCE、GREATEST、LEAST。

## NULLIF

如果相等返回 null，不相等返回第一个值。

```
select NULLIF(1,1), NULLIF(1,2);
```

```
+-------------+-------------+
| NULLIF(1,1) | NULLIF(1,2) |
+-------------+-------------+
|        NULL |           1 |
+-------------+-------------+
```

## COALESCE

返回第一个非 null 的值：

```
select COALESCE(null, 1), COALESCE(null, null, 2);
```

```
+-------------------+-------------------------+
| COALESCE(null, 1) | COALESCE(null, null, 2) |
+-------------------+-------------------------+
|                 1 |                       2 |
+-------------------+-------------------------+
```

## GREATEST、LEAST

返回几个值中最大最小的。

```
select GREATEST(1,2,3),LEAST(1,2,3,4);
```

```
+-----------------+----------------+
| GREATEST(1,2,3) | LEAST(1,2,3,4) |
+-----------------+----------------+
|               3 |              1 |
+-----------------+----------------+
```

## 类型转换函数

**转换类型为另一种，比如 CAST、CONVERT、DATE_FORMAT、STR_TO_DATE。**

CAST 和 CONVERT 都是用于数据类型转换的 SQL 函数，它们在某些数据库管理系统中可以互换使用，但在某些系统中可能有一些细微的区别。

主要区别如下：

语法：

CAST 语法：CAST(expression AS data_type). 例如：CAST('123' AS INT)
CONVERT 语法：CONVERT(data_type, expression). 例如：CONVERT(INT, '123')
支持性：

CAST 是 ANSI SQL 标准的一部分，因此在几乎所有支持 ANSI SQL 的数据库中都可以使用。
CONVERT 的可移植性可能会受到数据库系统的影响。在某些数据库系统中，如 Microsoft SQL Server，CONVERT 是特定于该系统的扩展，不一定在其他数据库中适用。
扩展性：

CONVERT 在某些数据库系统中可能支持更多的数据类型转换选项，包括可以指定格式的日期和时间转换。
总的来说，如果你希望编写具有较好可移植性的 SQL，建议使用 CAST，因为它是 ANSI SQL 标准的一部分。但如果你需要特定数据库系统的功能或格式化选项，可以查看数据库文档以确定哪个函数更适合你的需求。

```
select greatest(1, '123',3);
```

3 最大，因为它并没有把 '123' 当成数字

这时候就可以用 convert 或者 cast 做类型转换了：

```
select greatest(1, convert('123', signed),3);
```

这里可以转换的类型有这些：

| signed   | 整型         |
| -------- | ------------ |
| unsigned | 无符号整型   |
| decimal  | 浮点型       |
| char     | 字符类型     |
| date     | 日期类型     |
| time     | 时间类型     |
| datetime | 日期时间类型 |
| binary   | 二进制类型   |

剩下的 STR_TO_DATE 和 DATE_FORMAT 还是很容易理解的：

```
SELECT DATE_FORMAT('2022-01-01', '%Y年%m月%d日');
```

```
SELECT STR_TO_DATE('2023-06-01', '%Y-%m-%d');
```

## 总结

我们连接 mysql 数据库，建了张 student 表，插入了一些数据，然后用这些数据来练习了各种查询语法和函数。

- where：查询条件，比如 where id=1
- as：别名，比如 select xxx as 'yyy'
- and: 连接多个条件
- in/not in：集合查找，比如 where a in (1,2)
- between and：区间查找，比如 where a between 1 and 10
- limit：分页，比如 limit 0,5
- order by：排序，可以指定先根据什么升序、如果相等再根据什么降序，比如 order by a desc,b asc
- group by：分组，比如 group by aaa
- having：分组之后再过滤，比如 group by aaa having xxx > 5
- distinct：去重

sql 还可以用很多内置函数：

- 聚合函数：avg、count、sum、min、max
- 字符串函数：concat、substr、length、upper、lower
- 数值函数：round、ceil、floor、abs、mod
- 日期函数：year、month、day、date、time
- 条件函数：if、case
- 系统函数：version、datebase、user
- 类型转换函数：convert、cast、date_format、str_to_date
- 其他函数：nullif、coalesce、greatest、least

灵活掌握这些语法，就能写出各种复杂的查询语句。
